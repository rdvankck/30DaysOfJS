/* City-based logic */
    SET @cityParam = Lowercase(RequestParameter("city"))
    
    IF @cityParam == "glasgow" THEN
        SET @triggeredSendKey = "127699_Glasgow"
        SET @eventLocation = "Glasgow Event Center"
    ELSEIF @cityParam == "london" THEN
        SET @triggeredSendKey = "127699_London" 
        SET @eventLocation = "London Event Center"
    ELSEIF @cityParam == "manchester" THEN
        SET @triggeredSendKey = "127699_Manchester"
        SET @eventLocation = "Manchester Event Center"
    ELSE
        SET @triggeredSendKey = "127699"
        SET @eventLocation = "Main Event Location"
    ENDIF
    
    /* Upsert to Data Extension */
    SET @upsertResult = UpsertData("Jameson_UK_Meatopia_06_2025", 1, "EmailAddress", @emailAddress, 
        "FirstName", @firstName,
        "LastName", @lastName,
        "EmailAddress", @emailAddress,
        "SubmissionDate", @submissionDate,
        "DOB", @dobFormatted,
        "Consent", @consentBool,
        "ConsentPR", @consentPRBool,
        "City", @city
    )
    
    /* Send City-specific Triggered Email */
    SET @ts = CreateObject("TriggeredSend")
    SET @tsDef = CreateObject("TriggeredSendDefinition")
    SetObjectProperty(@tsDef, "CustomerKey", @triggeredSendKey)
    SetObjectProperty(@ts, "TriggeredSendDefinition", @tsDef)

%%[
/* Get URL parameters to pre-fill form */
SET @urlFirstName = RequestParameter("firstName")
SET @urlLastName = RequestParameter("lastName")
SET @urlEmail = RequestParameter("emailAddress")
SET @urlDOB = RequestParameter("dob")
SET @urlCity = RequestParameter("city")

/* CloudPage Handler - Form Processing */
SET @submitted = RequestParameter("submitted")
SET @showThankYou = "false"

IF @submitted == "true" THEN
    SET @firstName = RequestParameter("firstName")
    SET @lastName = RequestParameter("lastName")
    SET @emailAddress = RequestParameter("emailAddress")
    SET @dob = RequestParameter("dob")
    SET @city = RequestParameter("city")
    SET @consent = RequestParameter("consent")
    SET @consentPR = RequestParameter("consentPR")
    SET @submissionDate = FormatDate(NOW(), "dd MMMM yyyy HH:mm")

    IF @consent == "on" THEN
        SET @consentBool = "True"
    ELSE
        SET @consentBool = "False"
    ENDIF
    IF @consentPR == "on" THEN
        SET @consentPRBool = "True"
    ELSE
        SET @consentPRBool = "False"
    ENDIF
    IF NOT Empty(@dob) THEN
        SET @dobFormatted = FormatDate(ParseDate(@dob, "yyyy-MM-dd"), "dd MMMM yyyy HH:mm")
    ELSE
        SET @dobFormatted = ""
    ENDIF

    SET @upsertResult = UpsertData("Jameson_UK_Meatopia_06_2025", 1, "EmailAddress", @emailAddress, 
        "FirstName", @firstName,
        "LastName", @lastName,
        "EmailAddress", @emailAddress,
        "SubmissionDate", @submissionDate,
        "DOB", @dobFormatted,
        "Consent", @consentBool,
        "ConsentPR", @consentPRBool,
        "City", @city
    )
    SET @showThankYou = "true"
ENDIF
]%%

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jameson UK Meatopia 2025</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            margin: 50px auto;
            max-width: 600px;
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .event-title {
            color: #d4af37;
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .event-subtitle {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25);
        }
        
        .btn-submit {
            background: linear-gradient(45deg, #d4af37, #f1c40f);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-submit:disabled {
            background: #6c757d;
            transform: none;
            box-shadow: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .thank-you-section {
            text-align: center;
            display: none;
        }
        
        .thank-you-title {
            color: #28a745;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .thank-you-message {
            font-size: 1.3rem;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .form-check-input:checked {
            background-color: #d4af37;
            border-color: #d4af37;
        }
        
        .consent-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <!-- Form Section -->
            <div id="formSection" %%=IIF(@showThankYou=="true","style='display:none;'","")=%% >
                <div class="logo-section">
                    <h1 class="event-title">JAMESON</h1>
                    <h2 class="event-subtitle">UK Meatopia 20255</h2>
                    <p class="text-muted">Join us for an unforgettable culinary experience</p>
                </div>

                <form id="registrationForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" required maxlength="50" value="%%=v(@urlFirstName)=%%">
                            <div class="error-message" id="firstNameError">Please enter your first name</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" required maxlength="50" value="%%=v(@urlLastName)=%%">
                            <div class="error-message" id="lastNameError">Please enter your last name</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="emailAddress" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="emailAddress" name="emailAddress" required maxlength="254" value="%%=v(@urlEmail)=%%">
                        <div class="error-message" id="emailError">Please enter a valid email address</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dob" class="form-label">Date of Birth *</label>
                            <input type="date" class="form-control" id="dob" name="dob" required value="%%=v(@urlDOB)=%%">
                            <div class="error-message" id="dobError">You must be 18 or older to participate</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" maxlength="50" value="%%=v(@urlCity)=%%">
                        </div>
                    </div>

                    <div class="consent-section">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="consent" name="consent" required>
                            <label class="form-check-label" for="consent">
                                <strong>I consent to receive marketing communications from Jameson *</strong>
                            </label>
                            <div class="error-message" id="consentError">Please accept to continue</div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="consentPR" name="consentPR">
                            <label class="form-check-label" for="consentPR">
                                I consent to receive promotional materials and event updates
                            </label>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-warning btn-submit" id="submitBtn">
                            <span id="submitText">Register Now</span>
                            <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Thank You Section -->
            <div id="thankYouSection" class="thank-you-section" %%=IIF(@showThankYou=="true","style='display:block;'","style='display:none;'")=%% >
                <div class="success-icon">✓</div>
                <h2 class="thank-you-title">Thank You!</h2>
                <div class="thank-you-message">
                    <p><strong>Registration Successful!</strong></p>
                    <p>Welcome to Jameson UK Meatopia 2025!</p>
                    <p>You'll receive a confirmation email shortly with all the event details.</p>
                    <p>We can't wait to see you there!</p>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorAlert" class="alert alert-danger" style="display: none;">
                <strong>Error!</strong> Something went wrong. Please try again.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registrationForm');
            const formSection = document.getElementById('formSection');
            const thankYouSection = document.getElementById('thankYouSection');
            const errorAlert = document.getElementById('errorAlert');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');

            // Age validation
            function calculateAge(birthDate) {
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }

            // Validation functions
            function validateForm() {
                let isValid = true;
                
                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.form-control').forEach(el => el.classList.remove('is-invalid'));

                // First Name
                const firstName = document.getElementById('firstName');
                if (!firstName.value.trim()) {
                    document.getElementById('firstNameError').style.display = 'block';
                    firstName.classList.add('is-invalid');
                    isValid = false;
                }

                // Last Name
                const lastName = document.getElementById('lastName');
                if (!lastName.value.trim()) {
                    document.getElementById('lastNameError').style.display = 'block';
                    lastName.classList.add('is-invalid');
                    isValid = false;
                }

                // Email
                const email = document.getElementById('emailAddress');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!email.value.trim() || !emailRegex.test(email.value)) {
                    document.getElementById('emailError').style.display = 'block';
                    email.classList.add('is-invalid');
                    isValid = false;
                }

                // Date of Birth (18+ check)
                const dob = document.getElementById('dob');
                if (!dob.value || calculateAge(dob.value) < 18) {
                    document.getElementById('dobError').style.display = 'block';
                    dob.classList.add('is-invalid');
                    isValid = false;
                }

                // Consent
                const consent = document.getElementById('consent');
                if (!consent.checked) {
                    document.getElementById('consentError').style.display = 'block';
                    isValid = false;
                }

                return isValid;
            }

            // Form submit handler
            form.addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return;
                }

                // Show loading state
                submitBtn.disabled = true;
                submitText.textContent = 'Processing...';
                submitSpinner.style.display = 'inline-block';
                
                // Add hidden input for submitted flag
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'submitted';
                hiddenInput.value = 'true';
                form.appendChild(hiddenInput);
                
                // Let form submit naturally to same page
                // After submit, AMPScript will process and redirect back
            });

            // Real-time validation
            document.getElementById('emailAddress').addEventListener('blur', function() {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const errorEl = document.getElementById('emailError');
                if (this.value && !emailRegex.test(this.value)) {
                    errorEl.style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    errorEl.style.display = 'none';
                    this.classList.remove('is-invalid');
                }
            });

            document.getElementById('dob').addEventListener('change', function() {
                const errorEl = document.getElementById('dobError');
                if (this.value && calculateAge(this.value) < 18) {
                    errorEl.style.display = 'block';
                    this.classList.add('is-invalid');
                } else {
                    errorEl.style.display = 'none';
                    this.classList.remove('is-invalid');
                }
            });
        });
    </script>
</body>
</html>